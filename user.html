<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prerana Go</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary: #075E54; /* WhatsApp-like Green */
            --secondary: #128C7E;
            --accent: #25D366;
            --bg: #ECE5DD;
            --white: #ffffff;
            --dark: #1f1f1f;
            --gray: #888888;
            --light-gray: #f0f0f0;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Icons (SVG Classes) */
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 18px; height: 18px; }

        /* Layout */
        #app-container { flex: 1; overflow-y: auto; position: relative; background: var(--white); max-width: 600px; margin: 0 auto; width: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* Headers */
        header { background: var(--primary); color: var(--white); padding: 15px; display: flex; align-items: center; justify-content: space-between; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        header h1 { font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        header img.logo { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; background: white; }

        /* Progress Bar */
        #loading-bar { height: 3px; background: var(--accent); width: 0%; position: absolute; top: 0; left: 0; z-index: 9999; transition: width 0.3s; }

        /* Views */
        .view { display: none; padding: 15px; padding-bottom: 80px; animation: fadeIn 0.3s ease; height: 100%; overflow-y: auto; }
        .view.active { display: block; }

        /* Login/Auth */
        #auth-view { background: var(--white); z-index: 100; text-align: center; justify-content: center; flex-direction: column; padding: 40px 20px; }
        .auth-card { background: white; padding: 20px; border-radius: var(--radius); width: 100%; }
        .auth-header { margin-bottom: 30px; }
        .auth-header h1 { color: var(--primary); font-size: 28px; margin-bottom: 10px; }
        .auth-header p { color: var(--gray); font-size: 14px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--dark); font-size: 14px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: border 0.2s; font-size: 16px; }
        input:focus { border-color: var(--primary); }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn-link { background: none; color: var(--primary); margin-top: 15px; display: inline-block; cursor: pointer; font-size: 14px; }
        .error-msg { color: #d32f2f; font-size: 12px; margin-top: 5px; display: none; }

        /* Home */
        .slider-container { width: 100%; height: 180px; background: #ddd; border-radius: var(--radius); margin-bottom: 20px; overflow: hidden; position: relative; }
        .slide { width: 100%; height: 100%; object-fit: cover; display: none; }
        .slide.active { display: block; }
        
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { padding-left: 40px; background: var(--light-gray); border: none; }
        .search-box svg { position: absolute; left: 12px; top: 12px; color: var(--gray); }

        .section-title { font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        
        /* User List / Friends List */
        .user-list { list-style: none; }
        .user-item { display: flex; align-items: center; background: white; padding: 12px; border-radius: var(--radius); margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; }
        .user-avatar { width: 45px; height: 45px; background: var(--secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; margin-right: 15px; flex-shrink: 0; }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; color: var(--dark); font-size: 16px; }
        .user-detail { font-size: 12px; color: var(--gray); margin-top: 2px; }
        .action-btn { padding: 8px 12px; background: var(--light-gray); border-radius: 6px; font-size: 12px; color: var(--dark); border: none; cursor: pointer; }
        .action-btn.primary { background: var(--primary); color: white; }

        /* Announcement */
        .announcement-card { background: white; border-left: 4px solid var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .announcement-img { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-top: 10px; display: none; }

        /* Chat Interface */
        #chat-view { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #e5ddd5; z-index: 50; flex-direction: column; }
        #chat-header { background: var(--primary); padding: 10px 15px; color: white; display: flex; align-items: center; gap: 10px; }
        #chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; line-height: 1.4; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }
        .message.received { align-self: flex-start; background: white; border-top-left-radius: 0; }
        .msg-time { font-size: 10px; color: #999; text-align: right; margin-top: 4px; }
        .typing-indicator { font-size: 12px; color: var(--primary); padding: 5px 15px; display: none; font-style: italic; }
        
        #chat-input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; }
        #chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; }
        .chat-btn { background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

        /* Message Options Modal */
        #msg-options { position: fixed; bottom: -100px; left: 0; width: 100%; background: white; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); transition: bottom 0.3s; z-index: 200; display: flex; justify-content: space-around; }
        #msg-options.show { bottom: 0; }
        .opt-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--dark); cursor: pointer; }

        /* Settings */
        .settings-header { text-align: center; margin-bottom: 20px; }
        .large-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--primary); color: white; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; }
        .setting-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .setting-label { font-size: 14px; color: var(--dark); }
        .setting-sub { font-size: 12px; color: var(--gray); display: block; }
        
        /* Bottom Nav */
        nav { position: absolute; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 40; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--gray); background: none; border: none; font-size: 10px; gap: 4px; cursor: pointer; width: 25%; }
        .nav-item.active { color: var(--primary); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Utility */
        .hidden { display: none !important; }
        .big-link { font-size: 18px; font-weight: bold; color: var(--primary); text-decoration: none; display: block; margin: 10px 0; }
    </style>
</head>
<body>

    <!-- Loading Bar -->
    <div id="loading-bar"></div>

    <div id="app-container">
        
        <!-- Header -->
        <header id="main-header" class="hidden">
            <h1>
                <img src="vivek.png" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIi8+PHBhdGggZD0iTTcgMjAuNjYyVjE5YTIgMiAwIDAgMSAyLTJoNmEyIDIgMCAwIDEgMiAydjEuNjYyIi8+PC9zdmc+'" class="logo" alt="Logo">
                Prerana Go
            </h1>
            <div id="status-dot" style="width:10px; height:10px; background:#0f0; border-radius:50%;"></div>
        </header>

        <!-- Auth View -->
        <div id="auth-view" class="view active" style="display:flex;">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>Prerana Go</h1>
                    <p>Important: This application is only for Prerana students.</p>
                </div>
                
                <!-- Sign Up Form -->
                <div id="signup-form">
                    <h2 style="margin-bottom:15px;">Create a new fresh account</h2>
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="reg-name" placeholder="Enter your name">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="reg-email" placeholder="student@gmail.com">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="reg-pass" placeholder="Create password">
                    </div>
                    <div class="input-group">
                        <label>Confirm Password</label>
                        <input type="password" id="reg-conf-pass" placeholder="Confirm password">
                    </div>
                    <div class="error-msg" id="reg-error"></div>
                    <button class="btn" onclick="handleSignup()">Sign Up</button>
                    <button class="btn-link" onclick="toggleAuth('login')">I have already account? Login</button>
                    <p style="margin-top:20px; font-size:12px; color:gray;">Contact: vivekdalvi147@gamil.com</p>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="hidden">
                    <h2 style="margin-bottom:15px;">Welcome Back</h2>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="student@gmail.com">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="login-pass" placeholder="Enter password">
                    </div>
                    <div class="error-msg" id="login-error"></div>
                    <button class="btn" onclick="handleLogin()">Login</button>
                    <button class="btn-link" onclick="toggleAuth('signup')">I don't have account? Sign Up</button>
                    <p style="margin-top:20px; font-size:12px; color:gray;">Contact: vivekdalvi147@gamil.com</p>
                </div>
            </div>
        </div>

        <!-- Home View -->
        <div id="home-view" class="view">
            <!-- Slider -->
            <div class="slider-container" id="slider">
                <!-- Slides will be injected here -->
                <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#888;">No Announcements</div>
            </div>

            <!-- Announcements -->
            <div class="section-title">Announcements</div>
            <div id="announcement-list"></div>

            <div class="section-title">All Students</div>
            <!-- Search -->
            <div class="search-box">
                <svg class="icon icon-sm"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="user-search" placeholder="Search by Name or ID (e.g. 90786)" onkeyup="searchUsers()">
            </div>
            <ul class="user-list" id="all-users-list">
                <!-- Users injected here -->
            </ul>
        </div>

        <!-- Friends View -->
        <div id="friends-view" class="view">
            <div class="section-title">My Friends</div>
            <ul class="user-list" id="friends-list">
                <p style="text-align:center; color:gray; margin-top:50px;">You don't have any friends yet.</p>
            </ul>
        </div>

        <!-- Requests View -->
        <div id="requests-view" class="view">
            <div class="section-title">Friend Requests</div>
            <ul class="user-list" id="requests-list">
                 <p style="text-align:center; color:gray; margin-top:50px;">No pending requests.</p>
            </ul>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="view">
            <div class="settings-header">
                <div class="large-avatar" id="profile-avatar">U</div>
                <h2 id="profile-name">User Name</h2>
                <p id="profile-id" style="color:gray;">ID: -----</p>
            </div>

            <div class="section-title">Profile Settings</div>
            <div class="setting-item">
                <div>
                    <span class="setting-label">Change Name</span>
                </div>
                <input type="text" id="edit-name" style="width:120px; padding:5px;" onblur="updateProfile('name', this.value)">
            </div>

            <div class="setting-item">
                <div>
                    <span class="setting-label">Select Batch (1-80)</span>
                </div>
                <select id="batch-select" style="width:80px; padding:5px;" onchange="updateProfile('batch', this.value)">
                    <!-- Options generated by JS -->
                </select>
            </div>

            <div class="setting-item">
                <div>
                    <span class="setting-label">Education Status</span>
                </div>
                <input type="text" id="edu-status" placeholder="e.g. 12th Sci" style="width:120px; padding:5px;" onblur="updateProfile('education', this.value)">
            </div>

            <div class="section-title">Address & Privacy</div>
            <div class="setting-item" style="display:block;">
                <input type="text" id="addr-state" placeholder="State" style="margin-bottom:5px;">
                <input type="text" id="addr-dist" placeholder="District" style="margin-bottom:5px;">
                <input type="text" id="addr-city" placeholder="City">
                <button class="action-btn primary" style="margin-top:5px; width:100%;" onclick="saveAddress()">Save Address</button>
            </div>
            
            <div class="setting-item">
                <span class="setting-label">Who can see my address?</span>
                <select id="privacy-addr" onchange="updatePrivacy('address', this.value)">
                    <option value="me">Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="all">Everyone</option>
                </select>
            </div>

            <div class="setting-item">
                <span class="setting-label">Last Seen Visibility</span>
                <select id="privacy-seen" onchange="updatePrivacy('lastSeen', this.value)">
                    <option value="me">Only Me</option>
                    <option value="friends">Friends</option>
                    <option value="all">Everyone</option>
                </select>
            </div>

            <div class="section-title">More</div>
            <div style="text-align:center; padding:20px;">
                <p>Ask with Vivek's AI</p>
                <a href="https://bol-ai.vercel.app" class="big-link">Open Bol-AI</a>
                
                <h3 style="margin-top:20px;">About Us</h3>
                <p>Developer: Vivek Dalvi (Batch 25)</p>
                <p>Email: vivekdalvi147@gamil.com</p>
                <p style="font-size:12px; color:gray; margin-top:10px;">Version 1.0.0 | Prerana Go</p>
                
                <button class="btn" style="background:#d32f2f; margin-top:20px;" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Chat View (Overlay) -->
        <div id="chat-view">
            <div id="chat-header">
                <button class="opt-btn" onclick="closeChat()" style="color:white;"><svg class="icon"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <div class="user-avatar" id="chat-avatar" style="width:35px; height:35px; font-size:14px;">U</div>
                <div style="flex:1;">
                    <h3 id="chat-user-name" style="font-size:16px;">User</h3>
                    <span id="chat-status" style="font-size:12px; opacity:0.8;">Offline</span>
                </div>
            </div>
            <div id="chat-messages"></div>
            <div class="typing-indicator" id="typing-ind">Typing...</div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message..." oninput="handleTyping()">
                <button class="chat-btn" onclick="sendMessage()">
                    <svg class="icon icon-sm" style="margin-left:2px;"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>

        <!-- Message Options -->
        <div id="msg-options">
            <button class="opt-btn" onclick="copyMessage()"><svg class="icon"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>Copy</button>
            <button class="opt-btn" onclick="deleteMessage()"><svg class="icon"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>Delete</button>
            <button class="opt-btn" onclick="closeMsgOptions()"><svg class="icon"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>Cancel</button>
        </div>

        <!-- Navigation -->
        <nav id="main-nav" class="hidden">
            <button class="nav-item active" onclick="switchTab('home')">
                <svg class="icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Home
            </button>
            <button class="nav-item" onclick="switchTab('friends')">
                <svg class="icon"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                Friends
            </button>
            <button class="nav-item" onclick="switchTab('requests')">
                <svg class="icon"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                Requests
            </button>
            <button class="nav-item" onclick="switchTab('settings')">
                <svg class="icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Settings
            </button>
        </nav>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, addDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyClq3WavwvWqSOQl28QZQq96h_Ihg8X3YY",
            authDomain: "prerana-go.firebaseapp.com",
            projectId: "prerana-go",
            storageBucket: "prerana-go.firebasestorage.app",
            messagingSenderId: "986723238308",
            appId: "1:986723238308:web:a906d0b56bf0c575acc131"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Variables ---
        let currentUser = null;
        let currentUserData = null;
        let activeChatId = null;
        let currentChatUser = null;
        let chatUnsub = null;
        let selectedMsgId = null;

        // --- DOM Elements ---
        const views = {
            auth: document.getElementById('auth-view'),
            home: document.getElementById('home-view'),
            friends: document.getElementById('friends-view'),
            requests: document.getElementById('requests-view'),
            settings: document.getElementById('settings-view')
        };
        const nav = document.getElementById('main-nav');
        const header = document.getElementById('main-header');
        const loadingBar = document.getElementById('loading-bar');

        // --- Helpers ---
        const showLoading = () => loadingBar.style.width = '70%';
        const hideLoading = () => loadingBar.style.width = '0%';
        window.toggleAuth = (mode) => {
            document.getElementById('signup-form').classList.toggle('hidden', mode === 'login');
            document.getElementById('login-form').classList.toggle('hidden', mode === 'signup');
        };
        const getAvatar = (name) => name ? name.charAt(0).toUpperCase() : 'U';

        // --- Authentication ---
        window.handleSignup = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const confPass = document.getElementById('reg-conf-pass').value;
            const errBox = document.getElementById('reg-error');

            if (pass !== confPass) { errBox.innerText = "Passwords do not match"; errBox.style.display = 'block'; return; }
            if (!name || !email) { errBox.innerText = "Fill all fields"; errBox.style.display = 'block'; return; }

            showLoading();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                
                // Generate 5 digit ID
                let uniqueId = Math.floor(10000 + Math.random() * 90000).toString();
                // Ideally check if ID exists, skipping for single-file simplicity (collision rare)

                // Create User Doc
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    name: name,
                    email: email,
                    preranaId: uniqueId,
                    batch: "1",
                    address: { state:"", district:"", city:"" },
                    education: "",
                    friends: [],
                    requests: [],
                    privacy: { address: 'me', lastSeen: 'all' },
                    lastSeen: serverTimestamp(),
                    isOnline: true
                });
                
                errBox.style.display = 'none';
                hideLoading();
            } catch (error) {
                hideLoading();
                errBox.innerText = error.message;
                errBox.style.display = 'block';
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errBox = document.getElementById('login-error');

            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                errBox.style.display = 'none';
            } catch (error) {
                hideLoading();
                errBox.innerText = error.message;
                errBox.style.display = 'block';
            }
        };

        window.handleLogout = () => {
            // Set offline before logout
            if(currentUser) {
                updateDoc(doc(db, "users", currentUser.uid), { isOnline: false, lastSeen: serverTimestamp() });
            }
            signOut(auth);
            window.location.reload();
        };

        // --- Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // User logged in
                views.auth.classList.remove('active');
                views.auth.classList.add('hidden'); // Ensure hidden
                nav.classList.remove('hidden');
                header.classList.remove('hidden');
                
                // Fetch User Data
                const userDoc = await getDoc(doc(db, "users", user.uid));
                currentUserData = userDoc.data();
                
                // Init App
                updateOnlineStatus(true);
                setupBatchSelect();
                loadHome();
                loadFriends();
                loadRequests();
                loadSettings();
                switchTab('home');

                // Cleanup old chats (Simulated Logic)
                cleanupOldMessages();

            } else {
                // User logged out
                views.auth.classList.add('active');
                views.auth.classList.remove('hidden');
                nav.classList.add('hidden');
                header.classList.add('hidden');
                views.home.classList.remove('active');
                views.settings.classList.remove('active');
            }
            hideLoading();
        });

        const updateOnlineStatus = (status) => {
            if(currentUser) updateDoc(doc(db, "users", currentUser.uid), { isOnline: status, lastSeen: serverTimestamp() });
        };

        // --- Navigation ---
        window.switchTab = (tabName) => {
            Object.values(views).forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            views[tabName].classList.add('active');
            // Find button index roughly or by onclick logic - simplifying class add
            const btns = document.querySelectorAll('.nav-item');
            if(tabName === 'home') btns[0].classList.add('active');
            if(tabName === 'friends') btns[1].classList.add('active');
            if(tabName === 'requests') btns[2].classList.add('active');
            if(tabName === 'settings') btns[3].classList.add('active');
        };

        // --- Home Logic ---
        async function loadHome() {
            // 1. Load Slider (Admin only adds images via firestore manually for now, or use hardcoded demo URLs)
            const slider = document.getElementById('slider');
            const q = query(collection(db, "sliders")); // Assume admin added docs
            const snaps = await getDocs(q);
            if(!snaps.empty) {
                slider.innerHTML = '';
                snaps.forEach(doc => {
                    const d = doc.data();
                    const img = document.createElement('img');
                    img.src = d.imageUrl;
                    img.className = 'slide active'; // Simple logic: show all stacked or animate later
                    img.onclick = () => { if(d.link) window.open(d.link, '_blank'); };
                    slider.appendChild(img);
                });
            }

            // 2. Load Announcements
            const annList = document.getElementById('announcement-list');
            const annQ = query(collection(db, "announcements"));
            const annSnaps = await getDocs(annQ);
            annList.innerHTML = '';
            annSnaps.forEach(doc => {
                const d = doc.data();
                annList.innerHTML += `
                    <div class="announcement-card">
                        <p>${d.text}</p>
                        ${d.imageUrl ? `<img src="${d.imageUrl}" class="announcement-img" style="display:block">` : ''}
                    </div>
                `;
            });

            // 3. Load All Users (Initial Limit)
            searchUsers();
        }

        window.searchUsers = async () => {
            const term = document.getElementById('user-search').value.toLowerCase();
            const list = document.getElementById('all-users-list');
            list.innerHTML = '';

            const q = query(collection(db, "users"), limit(20)); // Security: don't load all at once
            const snaps = await getDocs(q);

            snaps.forEach(doc => {
                const u = doc.data();
                if(u.uid === currentUser.uid) return; // Don't show self

                if (u.name.toLowerCase().includes(term) || u.preranaId.includes(term)) {
                    // Logic to see button type (Add, Pending, Friend)
                    let btnHtml = `<button class="action-btn primary" onclick="sendRequest('${u.uid}')">Connect</button>`;
                    
                    if (currentUserData.friends.includes(u.uid)) btnHtml = `<button class="action-btn">Friend</button>`;
                    // Check requests (requires complex query or check user doc) - Simplification:
                    
                    list.innerHTML += `
                        <li class="user-item">
                            <div class="user-avatar">${getAvatar(u.name)}</div>
                            <div class="user-info">
                                <div class="user-name">${u.name} <span style="font-size:10px;color:#aaa">#${u.preranaId}</span></div>
                                <div class="user-detail">${u.education || 'Student'}</div>
                            </div>
                            ${btnHtml}
                        </li>
                    `;
                }
            });
        };

        window.sendRequest = async (targetUid) => {
            // Add to target's request list
            try {
                await updateDoc(doc(db, "users", targetUid), {
                    requests: arrayUnion(currentUser.uid)
                });
                alert("Request Sent!");
            } catch(e) { console.log(e); }
        };

        // --- Requests Logic ---
        async function loadRequests() {
            const list = document.getElementById('requests-list');
            // Re-fetch current user data to get latest requests
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            currentUserData = userDoc.data();
            
            const reqIds = currentUserData.requests || [];
            list.innerHTML = reqIds.length === 0 ? '<p style="text-align:center; color:gray; margin-top:50px;">No pending requests.</p>' : '';

            for (const uid of reqIds) {
                const rUser = (await getDoc(doc(db, "users", uid))).data();
                list.innerHTML += `
                    <li class="user-item">
                        <div class="user-avatar">${getAvatar(rUser.name)}</div>
                        <div class="user-info">
                            <div class="user-name">${rUser.name}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="action-btn primary" onclick="acceptRequest('${uid}')">Accept</button>
                            <button class="action-btn" onclick="rejectRequest('${uid}')" style="background:#fce8e6; color:red;">Reject</button>
                        </div>
                    </li>
                `;
            }
        }

        window.acceptRequest = async (friendUid) => {
            // Add to both friends lists, remove from requests
            const batch = db.batch || null; // Single file simplified, doing sequential await
            
            await updateDoc(doc(db, "users", currentUser.uid), {
                friends: arrayUnion(friendUid),
                requests: arrayRemove(friendUid)
            });
            
            await updateDoc(doc(db, "users", friendUid), {
                friends: arrayUnion(currentUser.uid)
            });
            
            loadRequests();
            loadFriends();
            alert("Friend Added!");
        };

        window.rejectRequest = async (uid) => {
            await updateDoc(doc(db, "users", currentUser.uid), {
                requests: arrayRemove(uid)
            });
            loadRequests();
        };

        // --- Friends Logic ---
        async function loadFriends() {
            const list = document.getElementById('friends-list');
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            currentUserData = userDoc.data();
            const friendIds = currentUserData.friends || [];
            
            list.innerHTML = friendIds.length === 0 ? '<p style="text-align:center; color:gray; margin-top:50px;">You don\'t have any friends yet.</p>' : '';

            for (const uid of friendIds) {
                const fUser = (await getDoc(doc(db, "users", uid))).data();
                list.innerHTML += `
                    <li class="user-item" onclick="openChat('${uid}')">
                        <div class="user-avatar">${getAvatar(fUser.name)}</div>
                        <div class="user-info">
                            <div class="user-name">${fUser.name}</div>
                            <div class="user-detail">Click to chat</div>
                        </div>
                        <svg class="icon" style="color:#25D366"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    </li>
                `;
            }
        }

        // --- Chat Logic ---
        window.openChat = async (uid) => {
            currentChatUser = (await getDoc(doc(db, "users", uid))).data();
            
            // Check privacy for Last Seen
            let statusText = "Offline";
            if(currentChatUser.isOnline) statusText = "Online";
            else {
                // Privacy check logic
                const canSee = currentChatUser.privacy.lastSeen === 'all' || (currentChatUser.privacy.lastSeen === 'friends' && currentChatUser.friends.includes(currentUser.uid));
                if(canSee && currentChatUser.privacy.lastSeen !== 'me') { // If user set to 'me', no one sees
                     // Also if *I* set mine to 'me', I shouldn't see others (WhatsApp logic requested)
                     if(currentUserData.privacy.lastSeen === 'me') statusText = "";
                     else {
                         const d = currentChatUser.lastSeen ? new Date(currentChatUser.lastSeen.seconds*1000) : new Date();
                         statusText = "Last seen: " + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                     }
                } else {
                    statusText = "";
                }
            }

            document.getElementById('chat-user-name').innerText = currentChatUser.name;
            document.getElementById('chat-avatar').innerText = getAvatar(currentChatUser.name);
            document.getElementById('chat-status').innerText = statusText;
            document.getElementById('chat-view').style.display = 'flex';

            // Chat ID: Sort UIDs to make consistent ID
            const ids = [currentUser.uid, uid].sort();
            activeChatId = ids[0] + "_" + ids[1];

            // Listen to messages
            const q = query(collection(db, "chats", activeChatId, "messages"), orderBy("timestamp", "asc"));
            chatUnsub = onSnapshot(q, (snapshot) => {
                const msgContainer = document.getElementById('chat-messages');
                msgContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const m = doc.data();
                    // Filter messages older than 24h visually if clean up hasn't run
                    const now = Date.now();
                    const msgTime = m.timestamp ? m.timestamp.toMillis() : now;
                    // if(now - msgTime > 86400000) return; // Uncomment to strict hide

                    const div = document.createElement('div');
                    div.className = `message ${m.sender === currentUser.uid ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        ${m.text}
                        <div class="msg-time">${new Date(msgTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    `;
                    // Long press logic
                    div.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        if(m.sender === currentUser.uid) {
                            selectedMsgId = doc.id;
                            document.getElementById('msg-options').classList.add('show');
                        }
                    });

                    msgContainer.appendChild(div);
                });
                msgContainer.scrollTop = msgContainer.scrollHeight;
            });
        };

        window.closeChat = () => {
            document.getElementById('chat-view').style.display = 'none';
            if(chatUnsub) chatUnsub();
            activeChatId = null;
        };

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text || !activeChatId) return;

            await addDoc(collection(db, "chats", activeChatId, "messages"), {
                text: text,
                sender: currentUser.uid,
                timestamp: serverTimestamp()
            });
            
            // Ensure chat doc exists for participants
            await setDoc(doc(db, "chats", activeChatId), {
                participants: [currentUser.uid, currentChatUser.uid],
                lastUpdated: serverTimestamp()
            }, { merge: true });

            input.value = '';
        };

        window.handleTyping = () => {
            // Implementation of typing indicator requires updating a field in chat doc
            // Simplified: omitted to keep code length manageable, but logic is updating 'typing: userId' in firestore
        };

        window.deleteMessage = async () => {
             if(selectedMsgId && activeChatId) {
                 await deleteDoc(doc(db, "chats", activeChatId, "messages", selectedMsgId));
                 closeMsgOptions();
             }
        };

        window.copyMessage = () => {
            // Logic to find text and copy
            closeMsgOptions();
            alert("Copied!");
        };

        window.closeMsgOptions = () => {
            document.getElementById('msg-options').classList.remove('show');
            selectedMsgId = null;
        };

        async function cleanupOldMessages() {
            // Client side check logic - cleaner runs on cloud functions usually
            // Here, we just don't display them in query or could delete manually
        }

        // --- Settings Logic ---
        function loadSettings() {
            document.getElementById('profile-name').innerText = currentUserData.name;
            document.getElementById('profile-id').innerText = "ID: " + currentUserData.preranaId;
            document.getElementById('profile-avatar').innerText = getAvatar(currentUserData.name);
            
            document.getElementById('edit-name').value = currentUserData.name;
            document.getElementById('batch-select').value = currentUserData.batch;
            document.getElementById('edu-status').value = currentUserData.education || "";
            
            if(currentUserData.address) {
                document.getElementById('addr-state').value = currentUserData.address.state;
                document.getElementById('addr-dist').value = currentUserData.address.district;
                document.getElementById('addr-city').value = currentUserData.address.city;
            }
            document.getElementById('privacy-addr').value = currentUserData.privacy.address;
            document.getElementById('privacy-seen').value = currentUserData.privacy.lastSeen;
        }

        function setupBatchSelect() {
            const sel = document.getElementById('batch-select');
            sel.innerHTML = '';
            for(let i=1; i<=80; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i;
                sel.appendChild(opt);
            }
        }

        window.updateProfile = async (field, value) => {
            await updateDoc(doc(db, "users", currentUser.uid), { [field]: value });
        };

        window.saveAddress = async () => {
            const s = document.getElementById('addr-state').value;
            const d = document.getElementById('addr-dist').value;
            const c = document.getElementById('addr-city').value;
            await updateDoc(doc(db, "users", currentUser.uid), { 
                address: { state: s, district: d, city: c } 
            });
            alert("Address Saved");
        };

        window.updatePrivacy = async (field, value) => {
            await updateDoc(doc(db, "users", currentUser.uid), { 
                ["privacy." + field]: value 
            });
        };

    </script>
</body>
</html>